#!/bin/bash
export NVM_DIR=/usr/local/nvm
. $NVM_DIR/nvm.sh
nvm use stable || { echo "could not use nvm"; exit 1; }
npm install gitbook-cli -g || { echo "could not install gitbook-cli"; exit 1; }

for i in 3.0 3.1 3.2 3.3 3.4 devel; do
    mkdir -p /tmp/$i
    cd /tmp/$i
    #get @GCHANGE_FREQ@ @GPRIORITY@ from VERSIONS file

    for book in AQL HTTP Manual Cookbook Drivers; do
        rm -fr book.json
        echo "Installing modules for book: $book in version $i"
        if ! curl --fail -O https://raw.githubusercontent.com/arangodb/arangodb/$i/Documentation/Books/${book}/book.json; then
            echo "could not download: https://raw.githubusercontent.com/arangodb/arangodb/$i/Documentation/Books/${book}/book.json continue"
            continue
        fi

        sed -e "s;@GCHANGE_FREQ@;0,4};" \
            -e "s;@GPRIORITY@;0.3;" \
            -i "book.json"

        gitbook install -g &> book_install.log || { echo "Failed to install modules"; cat book.json; exit 1; }
    done
done

echo "git book modules successfully installed"
